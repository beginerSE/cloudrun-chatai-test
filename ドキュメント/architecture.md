# BigQuery AI データ分析エージェント システムアーキテクチャ

**ドキュメントバージョン**: 1.0  
**作成日**: 2025年11月

---

## 1. システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Google Cloud Platform                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐                                                        │
│  │   社内ユーザー    │                                                        │
│  │  (ブラウザ)      │                                                        │
│  └────────┬─────────┘                                                        │
│           │ HTTPS                                                            │
│           ▼                                                                  │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │              Identity-Aware Proxy (IAP)                       │           │
│  │         ・Google Workspace認証                                │           │
│  │         ・社内ユーザーのみアクセス許可                          │           │
│  │         ・アクセスログ記録                                     │           │
│  └────────┬─────────────────────────────────────────────────────┘           │
│           │ 認証済みリクエスト                                               │
│           ▼                                                                  │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │                     Cloud Run                                 │           │
│  │  ┌────────────────────────────────────────────────────────┐  │           │
│  │  │              Flask Application                          │  │           │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐               │  │           │
│  │  │  │   Web    │ │   API    │ │  Static  │               │  │           │
│  │  │  │  Routes  │ │ Endpoints│ │  Files   │               │  │           │
│  │  │  └────┬─────┘ └────┬─────┘ └──────────┘               │  │           │
│  │  │       │            │                                    │  │           │
│  │  │       └──────┬─────┘                                    │  │           │
│  │  │              ▼                                          │  │           │
│  │  │  ┌──────────────────────────────────────────────────┐  │  │           │
│  │  │  │              AI Agent Core                        │  │  │           │
│  │  │  │  ┌────────────┐    ┌────────────────────────┐    │  │  │           │
│  │  │  │  │   OpenAI   │    │    MCP Server          │    │  │  │           │
│  │  │  │  │   Client   │◄──►│   (BigQuery)           │    │  │  │           │
│  │  │  │  └────────────┘    └───────────┬────────────┘    │  │  │           │
│  │  │  │  ┌────────────┐                │                  │  │  │           │
│  │  │  │  │   Gemini   │                │                  │  │  │           │
│  │  │  │  │   Client   │                │                  │  │  │           │
│  │  │  │  └────────────┘                │                  │  │  │           │
│  │  │  │  ┌────────────────────────────┐│                  │  │  │           │
│  │  │  │  │   Python Sandbox           ││                  │  │  │           │
│  │  │  │  │   (セキュア実行環境)        ││                  │  │  │           │
│  │  │  │  └────────────────────────────┘│                  │  │  │           │
│  │  │  └──────────────────────────────────────────────────┘  │  │           │
│  │  └────────────────────────────────────────────────────────┘  │           │
│  │           │                                    │              │           │
│  │           │ Unix Socket                        │ ADC          │           │
│  │           ▼                                    ▼              │           │
│  └──────────────────────────────────────────────────────────────┘           │
│           │                                       │                          │
│           │                                       │                          │
│           ▼                                       ▼                          │
│  ┌─────────────────────┐               ┌─────────────────────┐              │
│  │     Cloud SQL       │               │      BigQuery       │              │
│  │   (PostgreSQL)      │               │   (Data Warehouse)  │              │
│  │                     │               │                     │              │
│  │ ・ユーザー管理      │               │ ・企業データ        │              │
│  │ ・プロジェクト設定  │               │ ・分析対象テーブル   │              │
│  │ ・チャット履歴      │               │                     │              │
│  │ ・タスク状態        │               │                     │              │
│  └─────────────────────┘               └─────────────────────┘              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

外部サービス:
┌─────────────────────┐    ┌─────────────────────┐
│    OpenAI API       │    │   Google AI Studio  │
│   (GPT-4 / GPT-4o)  │    │   (Gemini 2.0)      │
└─────────────────────┘    └─────────────────────┘
```

---

## 2. コンポーネント詳細

### 2.1 Identity-Aware Proxy (IAP)

| 項目 | 詳細 |
|------|------|
| 役割 | 社内ユーザー認証・アクセス制御 |
| 認証方式 | Google Workspace アカウント |
| アクセス制御 | IAM ロール `roles/iap.httpsResourceAccessor` |
| ログ | Cloud Audit Logs に記録 |

### 2.2 Cloud Run

| 項目 | 詳細 |
|------|------|
| コンテナイメージ | Python 3.11 + Flask + Gunicorn |
| メモリ | 1GB（推奨: 2GB） |
| CPU | 1 vCPU（推奨: 2 vCPU） |
| リクエストタイムアウト | 300秒 |
| 最小インスタンス | 1（コールドスタート回避） |
| 最大インスタンス | 10（調整可能） |
| 同時実行数 | インスタンスあたり80 |

### 2.3 Cloud SQL (PostgreSQL)

| 項目 | 詳細 |
|------|------|
| バージョン | PostgreSQL 15 |
| インスタンスタイプ | db-f1-micro（開発）/ db-custom-2-4096（本番） |
| ストレージ | SSD 10GB（自動増加有効） |
| 高可用性 | リージョナル（本番環境推奨） |
| バックアップ | 自動バックアップ（日次、7世代保持） |
| 接続方式 | Unix Socket 経由 |

### 2.4 BigQuery

| 項目 | 詳細 |
|------|------|
| 認証方式 | ADC（Application Default Credentials） |
| 必要ロール | BigQuery Data Viewer, BigQuery Job User |
| クエリ制限 | SELECT文のみ（読み取り専用） |
| タイムアウト | 120秒 |

---

## 3. データフロー

### 3.1 AIチャット処理フロー

```
ユーザー                 Flask App              AI Agent              BigQuery
   │                        │                      │                     │
   │  1. 質問送信           │                      │                     │
   │ ──────────────────────►│                      │                     │
   │                        │  2. タスク作成        │                     │
   │                        │ ────────────────────►│                     │
   │  3. タスクID返却       │                      │                     │
   │ ◄──────────────────────│                      │                     │
   │                        │                      │                     │
   │  4. ステータス確認     │                      │                     │
   │ ──────────────────────►│                      │                     │
   │                        │                      │  5. list_tables     │
   │                        │                      │ ────────────────────►│
   │                        │                      │  6. テーブル一覧     │
   │                        │                      │ ◄────────────────────│
   │                        │                      │                     │
   │                        │                      │  7. describe_table  │
   │                        │                      │ ────────────────────►│
   │                        │                      │  8. スキーマ情報     │
   │                        │                      │ ◄────────────────────│
   │                        │                      │                     │
   │                        │                      │  9. execute_query   │
   │                        │                      │ ────────────────────►│
   │                        │                      │  10. クエリ結果      │
   │                        │                      │ ◄────────────────────│
   │                        │                      │                     │
   │  11. 処理ステップ更新  │                      │                     │
   │ ◄──────────────────────│                      │                     │
   │                        │                      │                     │
   │  12. 最終結果          │                      │                     │
   │ ◄──────────────────────│ ◄────────────────────│                     │
   │                        │                      │                     │
```

### 3.2 セッション管理フロー

```
ブラウザ                IAP                  Cloud Run            Cloud SQL
   │                    │                       │                     │
   │  1. HTTPS リクエスト│                       │                     │
   │ ──────────────────►│                       │                     │
   │                    │  2. Google認証確認    │                     │
   │                    │ ──────────────────────►                      │
   │                    │  3. IAP-JWT付与       │                     │
   │                    │ ──────────────────────►│                     │
   │                    │                       │  4. セッション確認   │
   │                    │                       │ ────────────────────►│
   │                    │                       │  5. ユーザー情報     │
   │                    │                       │ ◄────────────────────│
   │  6. レスポンス      │                       │                     │
   │ ◄──────────────────│ ◄──────────────────────│                     │
   │                    │                       │                     │
```

---

## 4. セキュリティアーキテクチャ

### 4.1 認証レイヤー

```
┌─────────────────────────────────────────────────────────────┐
│                     セキュリティレイヤー                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Layer 1: ネットワーク                                       │
│  ├─ HTTPS/TLS 1.2+強制                                       │
│  └─ Cloud Armor（DDoS保護）                                   │
│                                                              │
│  Layer 2: IAP認証                                            │
│  ├─ Google Workspaceアカウント必須                            │
│  ├─ 組織内ユーザーのみ許可                                    │
│  └─ コンテキストアウェアアクセス（オプション）                  │
│                                                              │
│  Layer 3: アプリケーション認証                                │
│  ├─ Flask-Login セッション管理                                │
│  ├─ bcrypt パスワードハッシュ                                 │
│  └─ 暗号化Cookie（SECRET_KEY）                               │
│                                                              │
│  Layer 4: データアクセス制御                                  │
│  ├─ ユーザーごとのプロジェクト分離                            │
│  ├─ BigQuery読み取り専用クエリ強制                            │
│  └─ SQLインジェクション防止                                   │
│                                                              │
│  Layer 5: 実行環境隔離                                       │
│  ├─ Pythonサンドボックス（制限されたglobals）                  │
│  ├─ 実行タイムアウト（30秒）                                  │
│  └─ ホワイトリスト方式のライブラリ許可                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 データ保護

| データ種別 | 保護方式 |
|-----------|----------|
| APIキー | データベース保存（暗号化推奨）、マスク表示 |
| パスワード | bcryptハッシュ化 |
| セッションCookie | 署名付き暗号化 |
| サービスアカウントJSON | ファイルシステム保存、権限制限 |
| 通信データ | TLS 1.2+暗号化 |

---

## 5. スケーラビリティ設計

### 5.1 水平スケーリング

```
                        Cloud Load Balancer
                               │
              ┌────────────────┼────────────────┐
              │                │                │
              ▼                ▼                ▼
        ┌──────────┐    ┌──────────┐    ┌──────────┐
        │ Cloud Run│    │ Cloud Run│    │ Cloud Run│
        │ Instance │    │ Instance │    │ Instance │
        │    #1    │    │    #2    │    │    #3    │
        └────┬─────┘    └────┬─────┘    └────┬─────┘
             │               │               │
             └───────────────┼───────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │   Cloud SQL    │
                    │  (Read Replica │
                    │   オプション)   │
                    └────────────────┘
```

### 5.2 スケーリング設定

| パラメータ | 設定値 | 説明 |
|-----------|--------|------|
| 最小インスタンス | 1 | コールドスタート回避 |
| 最大インスタンス | 10 | コスト制御 |
| 同時実行数 | 80 | インスタンスあたり |
| CPUアイドル時間 | 5分 | スケールダウン閾値 |

### 5.3 ステートレス設計

Cloud Run の複数インスタンス対応のため、以下をステートレス化：

| 項目 | 保存先 | 説明 |
|------|--------|------|
| タスク状態 | Cloud SQL `chat_tasks` テーブル | インメモリ辞書から移行 |
| セッション | 暗号化Cookie | サーバーサイドセッション不使用 |
| ファイルアップロード | 即座にDB保存 | ローカルファイル一時のみ |

---

## 6. 監視・ログ設計

### 6.1 監視項目

| メトリクス | 閾値 | アラート |
|-----------|------|----------|
| レスポンス時間 (P95) | > 5秒 | Warning |
| エラー率 | > 5% | Critical |
| Cloud SQL接続数 | > 80% | Warning |
| Cloud Run CPU使用率 | > 80% | Warning |
| メモリ使用率 | > 90% | Critical |

### 6.2 ログ構成

```
Cloud Logging
├── Application Logs
│   ├── INFO: リクエスト処理
│   ├── WARNING: 非致命的エラー
│   └── ERROR: 例外・障害
├── Access Logs
│   ├── IAP認証ログ
│   └── Cloud Runアクセスログ
└── Audit Logs
    ├── IAMポリシー変更
    └── リソース操作
```

---

## 7. 災害復旧設計

### 7.1 バックアップ戦略

| 対象 | 方式 | 保持期間 |
|------|------|----------|
| Cloud SQL | 自動バックアップ | 7日間 |
| Cloud SQL | ポイントインタイムリカバリ | 7日間 |
| コンテナイメージ | Artifact Registry | 無期限 |
| 設定 | Infrastructure as Code | Git管理 |

### 7.2 復旧手順概要

1. Cloud SQL: 自動バックアップからリストア
2. Cloud Run: 最新安定版イメージを再デプロイ
3. IAP: 設定はGCPプロジェクトに保持

### 7.3 RTO/RPO

| 指標 | 目標値 |
|------|--------|
| RTO (復旧時間目標) | 1時間 |
| RPO (復旧時点目標) | 24時間（日次バックアップ） |

---

## 8. 環境構成

### 8.1 環境一覧

| 環境 | 用途 | URL パターン |
|------|------|-------------|
| 開発 | 開発・テスト | dev-*.run.app |
| ステージング | 本番前検証 | staging-*.run.app |
| 本番 | 実運用 | prod-*.run.app またはカスタムドメイン |

### 8.2 環境変数

| 変数名 | 説明 | 設定方法 |
|--------|------|----------|
| DATABASE_URL | Cloud SQL接続文字列 | Secret Manager |
| SESSION_SECRET | セッション暗号化キー | Secret Manager |
| OPENAI_API_KEY | OpenAI APIキー（デフォルト） | Secret Manager（オプション） |
| GOOGLE_CLOUD_PROJECT | GCPプロジェクトID | 自動設定 |

---

## 9. 付録

### 9.1 技術スタック

| カテゴリ | 技術 | バージョン |
|----------|------|-----------|
| 言語 | Python | 3.11+ |
| フレームワーク | Flask | 3.0+ |
| WSGI | Gunicorn | 21.0+ |
| データベース | PostgreSQL | 15+ |
| フロントエンド | Bootstrap | 5.3 |
| グラフ | Chart.js | 4.4+ |
| AI | OpenAI API | GPT-4o |
| AI | Google Gemini API | 2.0 Flash |
| MCP | mcp-server-bigquery | Latest |

### 9.2 ポート構成

| ポート | 用途 |
|--------|------|
| 8080 | Cloud Run HTTPリスナー |
| 5432 | Cloud SQL PostgreSQL (Unix Socket) |
